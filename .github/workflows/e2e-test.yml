name: E2E Tests

on:
  pull_request:
    branches:
      - staging
      - prod
  push:
    branches:
      - staging
      - prod

jobs:
  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Determine test URL
        id: url
        run: |
          set -euo pipefail

          # PR時は staging/prod の固定URLではなく、Amplifyの「ブランチURL（プレビュー）」を叩く。
          # 例: https://develop.<appId>.amplifyapp.com
          #
          # NOTE:
          # - ブランチ名に `/` が含まれる場合、Amplify側でサブドメインが変換されることがあります。
          #   ここでは安全側に `/` を `-` に置換します（必要に応じて運用に合わせて調整してください）。
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ -z "${{ secrets.AMPLIFY_APP_ID }}" ]]; then
              echo "::error::Missing secret AMPLIFY_APP_ID. Set it to your Amplify appId (e.g. d3twt10pcsc29v)."
              exit 1
            fi

            branch_raw="${{ github.head_ref }}"
            branch_slug="${branch_raw//\//-}"
            echo "base_url=https://${branch_slug}.${{ secrets.AMPLIFY_APP_ID }}.amplifyapp.com" >> "$GITHUB_OUTPUT"
            echo "environment=preview" >> "$GITHUB_OUTPUT"
            echo "branch=${branch_raw}" >> "$GITHUB_OUTPUT"
            echo "branch_slug=${branch_slug}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # push（staging/prod）は従来通り固定URL
          if [[ "${{ github.ref }}" == "refs/heads/prod" ]] || [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "base_url=${{ secrets.PROD_URL }}" >> "$GITHUB_OUTPUT"
            echo "environment=production" >> "$GITHUB_OUTPUT"
          else
            echo "base_url=${{ secrets.STAGING_URL }}" >> "$GITHUB_OUTPUT"
            echo "environment=staging" >> "$GITHUB_OUTPUT"
          fi

      - name: Wait for URL to be ready (and not Amplify default page)
        id: probe
        run: |
          set -euo pipefail

          url="${{ steps.url.outputs.base_url }}"
          echo "Waiting for: $url"

          # 最大 10 分待つ（5秒 * 120回）
          max_attempts=120
          for i in $(seq 1 "$max_attempts"); do
            status="$(curl -s -o /tmp/page.html -w '%{http_code}' --max-time 20 "$url" || true)"
            body="$(head -c 20000 /tmp/page.html 2>/dev/null || true)"

            if [[ "$status" == "200" ]] && ! echo "$body" | grep -q "Your app will appear here once you complete your first deployment"; then
              echo "ready=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "Attempt ${i}/${max_attempts}: status=${status} (not ready yet)"
            sleep 5
          done

          echo "::error::Preview URL is not ready: ${url}"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "::error::Make sure the Amplify branch '${{ steps.url.outputs.branch }}' exists and is deploying, or enable auto branch creation / PR previews."
          fi
          echo "::error::Last status=${status}. If the body shows 'Your app will appear here...', it's pointing to an Amplify default page."
          exit 1

      - name: Run E2E tests
        run: pnpm test:e2e
        env:
          BASE_URL: ${{ steps.url.outputs.base_url }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ steps.url.outputs.environment }}
          path: apps/web/playwright-report/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload test videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos-${{ steps.url.outputs.environment }}
          path: apps/web/test-results/
          retention-days: 7
          if-no-files-found: warn
