name: Deploy Notification

on:
  push:
    branches:
      - develop
      - staging
      - prod

jobs:
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/prod" ]]; then
            echo "environment=üöÄ Êú¨Áï™Áí∞Â¢É" >> $GITHUB_OUTPUT
            echo "color=#FF0000" >> $GITHUB_OUTPUT
            echo "url=${{ secrets.PROD_URL }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "environment=üß™ „Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞Áí∞Â¢É" >> $GITHUB_OUTPUT
            echo "color=#FFA500" >> $GITHUB_OUTPUT
            echo "url=${{ secrets.STAGING_URL }}" >> $GITHUB_OUTPUT
          else
            echo "environment=üîß ÈñãÁô∫Áí∞Â¢É" >> $GITHUB_OUTPUT
            echo "color=#00FF00" >> $GITHUB_OUTPUT
            echo "url=${{ secrets.DEV_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Get commit info
        id: commit
        run: |
          echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha=$(git log -1 --pretty=%h)" >> $GITHUB_OUTPUT

      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ steps.env.outputs.environment }} „Å∏„ÅÆ„Éá„Éó„É≠„Ç§„ÅåÈñãÂßã„Åï„Çå„Åæ„Åó„Åü",
              "attachments": [{
                "color": "${{ steps.env.outputs.color }}",
                "fields": [
                  {
                    "title": "Áí∞Â¢É",
                    "value": "${{ steps.env.outputs.environment }}",
                    "short": true
                  },
                  {
                    "title": "„Éñ„É©„É≥„ÉÅ",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "„Ç≥„Éü„ÉÉ„Éà",
                    "value": "${{ steps.commit.outputs.sha }}",
                    "short": true
                  },
                  {
                    "title": "‰ΩúÊàêËÄÖ",
                    "value": "${{ steps.commit.outputs.author }}",
                    "short": true
                  },
                  {
                    "title": "„Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏",
                    "value": "${{ steps.commit.outputs.message }}",
                    "short": false
                  },
                  {
                    "title": "URL",
                    "value": "${{ steps.env.outputs.url }}",
                    "short": false
                  }
                ]
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
