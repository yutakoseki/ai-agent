name: Deploy Notification

on:
  push:
    branches:
      - develop
      - staging
      - prod

jobs:
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/prod" ]]; then
            echo "environment=ğŸš€ æœ¬ç•ªç’°å¢ƒ" >> $GITHUB_OUTPUT
            echo "color=#FF0000" >> $GITHUB_OUTPUT
            echo "url=${{ secrets.PROD_URL }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "environment=ğŸ§ª ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ" >> $GITHUB_OUTPUT
            echo "color=#FFA500" >> $GITHUB_OUTPUT
            echo "url=${{ secrets.STAGING_URL }}" >> $GITHUB_OUTPUT
          else
            echo "environment=ğŸ”§ é–‹ç™ºç’°å¢ƒ" >> $GITHUB_OUTPUT
            echo "color=#00FF00" >> $GITHUB_OUTPUT
            echo "url=${{ secrets.DEV_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Get commit info
        id: commit
        run: |
          # æ”¹è¡Œã‚’å‰Šé™¤ã—ã¦ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          MESSAGE=$(git log -1 --pretty=%B | tr '\n' ' ' | sed 's/"/\\"/g')
          echo "message=${MESSAGE}" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha=$(git log -1 --pretty=%h)" >> $GITHUB_OUTPUT

      - name: Notify Slack
        # SLACK_WEBHOOK ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        if: always() && secrets.SLACK_WEBHOOK != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ steps.env.outputs.environment }} ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ",
              "attachments": [{
                "color": "${{ steps.env.outputs.color }}",
                "fields": [
                  {
                    "title": "ç’°å¢ƒ",
                    "value": "${{ steps.env.outputs.environment }}",
                    "short": true
                  },
                  {
                    "title": "ãƒ–ãƒ©ãƒ³ãƒ",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "ã‚³ãƒŸãƒƒãƒˆ",
                    "value": "${{ steps.commit.outputs.sha }}",
                    "short": true
                  },
                  {
                    "title": "ä½œæˆè€…",
                    "value": "${{ steps.commit.outputs.author }}",
                    "short": true
                  },
                  {
                    "title": "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
                    "value": "${{ steps.commit.outputs.message }}",
                    "short": false
                  },
                  {
                    "title": "URL",
                    "value": "${{ steps.env.outputs.url }}",
                    "short": false
                  }
                ]
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
