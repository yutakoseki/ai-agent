#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

total_steps=6
current_step=0
total_start="$(date +%s)"
summary_lines=""
color_ok=""
color_ng=""
color_skip=""
color_reset=""

if [ -t 1 ] || [ -t 2 ]; then
  color_ok="$(printf '\033[32m')"
  color_ng="$(printf '\033[31m')"
  color_skip="$(printf '\033[33m')"
  color_reset="$(printf '\033[0m')"
fi

step_prefix() {
  printf "[pre-push][%s/%s]" "$current_step" "$total_steps"
}

start_step() {
  label="$1"
  command="$2"
  rerun="$3"
  current_step="$((current_step + 1))"
  prefix="$(step_prefix)"
  printf "\n%s START %s\n" "$prefix" "$label"
  printf "%s CMD   %s\n" "$prefix" "$command"
  printf "%s RETRY %s\n" "$prefix" "$rerun"
}

finish_step() {
  step_state="$1"
  step_label="$2"
  step_elapsed="$3"
  prefix="$(step_prefix)"
  colored_state="$step_state"
  case "$step_state" in
    "OK   ")
      colored_state="${color_ok}${step_state}${color_reset}"
      ;;
    "NG   ")
      colored_state="${color_ng}${step_state}${color_reset}"
      ;;
    "SKIP ")
      colored_state="${color_skip}${step_state}${color_reset}"
      ;;
  esac

  line="$(printf "%s %s %s (%ss)" "$prefix" "$colored_state" "$step_label" "$step_elapsed")"
  printf "%s\n" "$line"
  if [ -n "$summary_lines" ]; then
    summary_lines="${summary_lines}
$line"
  else
    summary_lines="$line"
  fi
}

print_total() {
  total_state="$1"
  total_end="$(date +%s)"
  total_elapsed="$((total_end - total_start))"
  printf "\n[pre-push] Summary\n"
  printf "%s" "$summary_lines"
  printf "\n[pre-push] %s total %ss\n" "$total_state" "$total_elapsed"
}

run_step() {
  label="$1"
  command="$2"
  rerun="$3"
  shift 3
  start_step "$label" "$command" "$rerun"
  start_time="$(date +%s)"

  if "$@"; then
    end_time="$(date +%s)"
    elapsed="$((end_time - start_time))"
    finish_step "OK   " "$label" "$elapsed"
    return 0
  fi

  exit_code="$?"
  end_time="$(date +%s)"
  elapsed="$((end_time - start_time))"
  finish_step "NG   " "$label" "$elapsed" >&2
  prefix="$(step_prefix)"
  printf "%s RETRY %s\n" "$prefix" "$rerun" >&2
  print_total "FAILED"
  exit "$exit_code"
}

run_pytest_step() {
  label="$1"
  command="$2"
  rerun="$3"
  start_step "$label" "$command" "$rerun"
  start_time="$(date +%s)"

  if pytest services/agent-core; then
    end_time="$(date +%s)"
    elapsed="$((end_time - start_time))"
    finish_step "OK   " "$label" "$elapsed"
    return 0
  fi

  exit_code="$?"
  if [ "$exit_code" -ne 5 ]; then
    end_time="$(date +%s)"
    elapsed="$((end_time - start_time))"
    finish_step "NG   " "$label" "$elapsed" >&2
    prefix="$(step_prefix)"
    printf "%s RETRY %s\n" "$prefix" "$rerun" >&2
    print_total "FAILED"
    exit "$exit_code"
  fi

  echo "pytest: no tests collected in services/agent-core (skipping)"
  end_time="$(date +%s)"
  elapsed="$((end_time - start_time))"
  finish_step "SKIP " "$label" "$elapsed"
}

run_step "Webユニットテスト: 主要なロジック/ミドルウェアの動作確認" \
  "pnpm --filter @ai-agent/web test" \
  "pnpm --filter @ai-agent/web test" \
  pnpm --filter @ai-agent/web test

run_step "Web統合テスト: APIルートの結合動作確認" \
  "pnpm --filter @ai-agent/web test:integration" \
  "pnpm --filter @ai-agent/web test:integration" \
  pnpm --filter @ai-agent/web test:integration

run_step "Webビルド: 本番ビルドと型/静的チェックの確認" \
  "pnpm --filter @ai-agent/web build" \
  "pnpm --filter @ai-agent/web build" \
  pnpm --filter @ai-agent/web build

run_step "Python静的解析: コード品質チェック" \
  "ruff check services/agent-core" \
  "ruff check services/agent-core" \
  ruff check services/agent-core

run_pytest_step "Pythonテスト: ユニットテストの実行" \
  "pytest services/agent-core" \
  "pytest services/agent-core"

run_step "Terraform検証: フォーマットと設定の妥当性確認" \
  "cd infra/terraform && terraform fmt -check && terraform init -backend=false && terraform validate -no-color" \
  "cd infra/terraform && terraform fmt -check && terraform init -backend=false && terraform validate -no-color" \
  sh -c "cd infra/terraform && terraform fmt -check && terraform init -backend=false && terraform validate -no-color"

print_total "DONE"
