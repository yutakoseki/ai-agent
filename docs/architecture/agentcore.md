# AgentCore 連携方針（非同期優先）

## 境界と責務

- BFF (apps/web Route Handler) で認証・RBAC・テナント検証を終端し、AgentCore にはテナントスコープ済みのジョブ/API のみ渡す。
- AgentCore は業務ユニットエージェントの実行に集中し、入出力スキーマ検証・権限スコープチェック・監査ログを共通実装する。

## 通信パターン

- 非同期優先: キューにジョブを積み、ワーカーで実行。冪等性キーを付与し、リトライポリシーを統一。
- 同期 API は最小限: 同期が必要な場合も BFF で RBAC/テナントを終端し、AgentCore 側で二重チェック＋タイムアウトを設定。

## スキーマとマッピング

- `packages` に入出力スキーマ/DTO を定義し、BFF と AgentCore 双方で共有してドリフトを防止。
- ステップ間の入出力マッピングは事前検証し、不足フィールドは実行前にエラーを返す。

## 監査・可観測性

- 各ステップの入力/出力/承認/失敗を記録し、PII はマスキングまたはハッシュ化。
- トレース ID/ジョブ ID を付与し、BFF→AgentCore→ 下流のログを関連付け。

## エラー/例外

- リトライは冪等な操作に限定。非冪等は「再実行は要承認」などのポリシーを設ける。
- エラー分類: ユーザ入力不足 / 認可不足 / 外部依存失敗 / システム異常 を区別し、ユーザ返却メッセージを整理。

## セキュリティ

- write 系エージェントには承認ゲートをデフォルト挿入可能とし、実行者と承認者を RBAC で分離。
- コネクタのスコープは read/write/notify を明示し、write は別エージェントに分離して最小権限を徹底。

