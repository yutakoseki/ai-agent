# DynamoDB 設計 (マルチテナント/RLS 相当)

## 目的

- RLS がない DynamoDB でテナント分離を担保するキー設計とアプリ側ガードを定義する。
- Terraform で IaC 管理し、環境ごとの差分・権限を明示する。
- ローカル/CI では DynamoDB Local で再現可能にする。

## 設計原則

- すべてのパーティションキーに `tenantId` を含める（物理分離度を高める）。
- テナント外アクセスはアプリ層で拒否し、DynamoDB には `ConditionExpression` で PK を固定して二重防御。
- 監査/実行ログも同一テーブルに格納し、`traceId` など相関情報を保持。

## テーブルレイアウト（シングルテーブル）

- テーブル名例: `aiagent-app`
- PK: `PK = TENANT#<tenantId>`
- SK: 種別 + 識別子でプレフィックス
  - テナント: `SK = TENANT#<tenantId>`
  - ユーザー: `SK = USER#<userId>`
  - エージェント: `SK = AGENT#<agentId>`
  - 実行履歴: `SK = EXEC#<executionId>`
  - 監査ログ: `SK = AUDIT#<timestamp>#<uuid>`
- GSI 例
  - `GSI1`（種別横断検索）: `GSI1PK = SK_PREFIX`（例: `USER`, `AGENT`）, `GSI1SK = PK` or `createdAt`
  - `GSI2`（ユーザー逆引きが必要な場合）: `GSI2PK = USER#<userId>`, `GSI2SK = TENANT#<tenantId>`
- TTL: セッション/一時トークン系アイテムに付与（例: `expiresAt` を TTL 属性に設定）。
- 暗号化: KMS デフォルト有効化。
- バックアップ: PITR 有効化。

### アイテム例

- テナント
  - `PK=TENANT#t1`, `SK=TENANT#t1`, `name`, `plan`, `enabled`
- ユーザー
  - `PK=TENANT#t1`, `SK=USER#u1`, `email`, `role`, `name`, `createdAt`
- 実行履歴
  - `PK=TENANT#t1`, `SK=EXEC#exec1`, `agentId`, `status`, `traceId`, `inputSummary`, `createdAt`
- 監査
  - `PK=TENANT#t1`, `SK=AUDIT#2024-01-01T00:00:00Z#uuid`, `action`, `resource`, `actorUserId`, `traceId`

### アクセスパターンとクエリ

- テナント内ユーザー一覧: `Query PK=TENANT#<tenantId>`, `begins_with(SK,'USER#')`
- 実行履歴一覧: `Query PK=TENANT#<tenantId>`, `begins_with(SK,'EXEC#')`
- 監査ログ: 上記に加え期間絞り（`SK BETWEEN AUDIT#ts1 AND AUDIT#ts2`）
- テナント逆引き（必要なら）: `GSI2PK=USER#<userId>` で所属テナントを取得

### 一貫性と同時実行制御

- 作成/更新時は `ConditionExpression` で `attribute_not_exists(PK)` / 楽観ロック用の `version` を併用。
- テナントチェックをアプリ層で実施した上で、DynamoDB 側も `PK = TENANT#<tenantId>` を固定して二重防御。

## ローカル/CI 運用

- DynamoDB Local を docker-compose で起動し、テーブル作成＋シードスクリプトを `scripts/seed-dynamodb.ts` などで用意。
- Vitest 統合テストは setup で Local に対してシードしてから実行。

## IaC とデプロイ方針

- **リソースは Amplify の自動生成を使わず Terraform で作成**する。理由:
  - 環境差分と権限をコードで明示し、ブランチやワークスペースで管理できる。
  - Amplify プロジェクト外からも再利用しやすい（将来他のワーカー/バッチが増えても同じテーブルを参照可能）。
- Terraform で定義するもの:
  - DynamoDB テーブル (PK/SK/GSI/TTL/PITR/KMS)
  - IAM ロール/ポリシー（Amplify の実行ロールにテーブルへのアクセス権を付与）
  - 環境別 state/backends, workspace, tags

## Amplify Gen2 との権限

- Amplify 側で自動作成されたテーブルは **使わず**、Terraform 管理のテーブルを参照する。
- Amplify のアプリロール（またはブランチ/バックエンド環境ロール）に対し、Terraform で発行した IAM ポリシーをアタッチすればアクセス可能。
  - Next.js (SSR/Route Handler) はそのロールの権限で `@aws-sdk/client-dynamodb` を呼ぶ。
  - 必要な環境変数（テーブル名、リージョン、エンドポイント）を Amplify 環境変数に設定。
- これにより「Amplify 自動権限」には依存せず、最小権限ポリシーをコードで管理できる。

## 今後の実装タスク（抜粋）

1. Terraform に DynamoDB テーブル/GSI/TTL/PITR/KMS を追加 (`infra/terraform/dynamodb/*.tf`)。
2. Amplify 実行ロールに付与する IAM ポリシーを Terraform で定義（最小権限: テーブル単位の read/write + describe）。
3. `packages/db-dynamo`（新規）で DocumentClient ラッパとテナントスコープ付き CRUD を実装。
4. API ルートをモックから DynamoDB 実体に置き換え（リポジトリ層経由）。
5. DynamoDB Local 用の docker-compose とシードスクリプトを追加し、Vitest 統合テストを Local 実行に切り替え。
