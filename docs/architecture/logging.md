# ログレベル設計と運用ルール（初期案）

## 目的と範囲

- BFF (`apps/web`) と AgentCore、バッチ・キュー処理を含む全コンポーネントのアプリケーションログを統一する。
- 監査ログ・セキュリティガードレールの初期案（`docs/architecture/audit-security.md`）を前提に、開発〜本番でぶれない運用を定義する。

## 基本方針

- デフォルト出力は構造化 JSON。最低限 `traceId`, `requestId` (または `jobId`), `tenantId`, `userId`, `label` をフィールドで持つ。
- PII/秘密情報（パスワード、トークン、個人情報）は **出力しない**。やむを得ない場合はマスキング/ハッシュ化し、元データを復元できない形にする。
- BFF→AgentCore→外部コネクタでトレース ID を伝搬し、相関できることを最優先にする。
- 監査ログと通常アプリログは用途を分ける（監査は「誰が / 何を / どのテナントで / どうしたか」を記録し、ビジネス入力は原則マスク）。

## ログレベル定義（Do / Don't）

- `fatal`: プロセス継続不能。例: 起動時必須設定欠如、致命的な初期化失敗。→ 即時アラート。
- `error`: リクエスト/ジョブの失敗や予期せぬ例外。再試行が必要な外部依存の失敗を含む。→ アラート対象。
- `warn`: リトライ・フォールバックで復旧した事象、外部依存の遅延、入力不足など「気づきが必要だが即時影響は限定的」なもの。
- `info`: 正常系の重要イベント。例: リクエスト受信/完了、主要な状態遷移、承認フロー通過。過剰に多くしない（リクエスト/ジョブ単位で 1〜数行を目安）。
- `debug`: 開発・障害調査向けの詳細。例: 分岐結果、外部 API のサマリ、キャッシュヒット/ミス。センシティブなペイロードは出さない。
- `trace`: 最詳細（ステップごとの入力/出力サマリ）。本番では原則オフか、期間・条件付きサンプリングでのみ使用。

## 環境別のデフォルトと切り替え

- 環境変数例: `LOG_LEVEL`, `LOG_PRETTY`（ローカルのみ true 推奨）。
- デフォルト方針: 本番/ステージングは `info`、開発は `debug`、CI は `warn` もしくは `info`（テスト失敗時に必要な最小限）。
- 一時的な障害調査では `LOG_LEVEL=debug` に引き上げてもよいが、期間を限定し、終了後に必ず戻す。

## 出力フォーマットとフィールド

- JSON 1 行出力。キー例:
  - `timestamp`, `level`, `msg`
  - `traceId`, `requestId`/`jobId`
  - `tenantId`, `userId`, `sessionId`（必要に応じて）
  - `label`（例: `"POST /api/auth/login"`）、`durationMs`, `statusCode`
  - `error`（スタックトレースは `error.stack` フィールドへ）
- ローカル開発は `LOG_PRETTY=true` で human-readable、その他は JSON 固定。

## エラーハンドリングのルール

- 例外は `error` で 1 回だけ記録し、スタックを付与する。多重ロギングを避ける。
- 予期したアプリケーションエラー（バリデーション失敗など）は `warn` ないし `info` で十分。ユーザーに返すメッセージとログ内容を分離し、内部情報を漏らさない。
- `traceId` を必ず付与し、呼び出し元と下流のログで相関できるようにする。

## 監査ログとの切り分け

- 監査ログは「誰が/どのテナントで/どのリソースを/どう操作したか」を必須項目とし、ビジネス入力はマスクする。
- 承認ゲート通過、権限昇格、設定変更などの管理操作は必ず監査ログに残す。
- 監査ログは変更不可能（WORM 相当）なストレージを検討し、保持期間を明示する。

## サンプリングと量制御

- 高頻度イベントは `info`/`debug` をサンプリング可能にする（例: `LOG_SAMPLING_DEBUG=0.1`）。
- 重複する詳細ログは、`trace` でのみ出し、通常レベルではサマリに留める。

## 運用・アラート

- `error` と `fatal` はメトリクス化し、閾値で通知する（例: 5xx 率、ジョブ失敗率）。
- 外部依存の遅延/失敗は `warn` + メトリクス（レイテンシ、リトライ回数）で観測する。
- ログローテーション/保持期間はデプロイ先のログ基盤に従う（例: CloudWatch で 30〜90 日保持、長期はストレージにアーカイブ）。

## 今後の実装メモ

- `packages/config` に `LOG_LEVEL`/`LOG_PRETTY` を追加し、スキーマバリデーションを通す。
- 共通ロガー（例: `apps/web/lib/logger.ts`）を用意し、`handleError` や API ルートが `console` ではなくロガー経由で出力する。
- 監査ログ用の別ストリーム/テーブルを設計し、PII マスキングを必須化する。
