# 情報収集・要約・投稿（MVP）

## スコープ
- RSS/Atom から収集し、要約生成して X/ブログ案を表示する。
- 自動投稿は対象外（将来拡張）。

## 収集フロー
- 単一スケジュール起動（固定間隔）。
- `next_fetch_at <= now` のソースを DB から取得する。
- ETag/If-Modified-Since を付与して取得し、更新がない場合は保存しない。
- 新規アイテムのみ保存し、URL/hash の重複は除外する。
- 初回取得は最新 5 件までに限定し、古いアイテムは保存しない。

## 初期運用パラメータ
- スケジュール間隔: 6 時間（1日 4 回）
- 1 回の起動で処理するソース上限: 200 件
- 同時取得数: 5 件
- 1 ソースあたりの保存上限: 最新 5 件

## パラメータ補足
- 1 回の起動で処理するソース上限は、Scheduler Lambda が 1 実行で処理する量を制限するための上限。
- 上限を超える場合は次回スケジュールで続行し、必要に応じてキュー分割で水平処理する。

## EventBridge 発火から下書き生成まで
1. EventBridge Scheduler が起動する。
2. Scheduler Lambda が `next_fetch_at <= now` のソースを取得する。
3. 取得対象をキューに投入し、Fetcher が RSS を取得する。
4. 新規アイテムを保存し、要約生成のジョブを作成する。
5. Summarizer が下書きを作成し、UI に表示する。

## 重複判定ルール
- `guid` があれば最優先。
- 次点で正規化済み URL（`utm_*` などのトラッキングは除外）。
- 最後に `title + published_at + link` のハッシュで判定。

## 本文抽出と前処理
- `content:encoded` → `description/summary` の順で採用。
- HTML を除去してプレーンテキスト化。
- 文字数は 4,000 文字で打ち切る。

## 要約生成
- 生成単位はアイテム単位。
- blog 案: 3〜5点の箇条書き + 短い見出し。
- X 案: 140〜280字で 1〜2 案。
- 生成結果は下書きとして保存し、UI で編集・コピーできる。
- 新規アイテム保存時に自動生成（デフォルトは X のみ）。
- 生成対象はユーザー設定で blog のみ / X のみ / 両方 を選択できる。
- クォータ超過時は生成をスキップし、翌日再開する。

## プラン制限の適用ポイント
- ソース登録時: `active` なソース数が `max_sources` 未満であること。
- 要約生成時: `summaries_used < max_summaries_per_day` の範囲で生成する。
- 同時実行を想定し、生成直前に原子的に使用量を加算して上限超過を防ぐ。

## 失敗時の扱い
- 取得や要約に失敗したソースは次回スケジュールで再試行する。
- 失敗回数は記録し、UI で可視化する。

## データ保持
- items は 180 日、drafts は 90 日保持。
- 期限を過ぎたデータは定期削除する。

## 将来の自動投稿
- X/ブログの投稿 API 連携を追加し、下書き → 投稿のフローに拡張する。
- 投稿はユーザー承認を前提とし、いきなり自動投稿しない。
