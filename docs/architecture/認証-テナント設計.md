# 認証 / RBAC / テナント分離

## 境界と終端
- 認証とテナント判定は BFF (apps/web Route Handler) で終端。AgentCore にはテナントスコープ済みリクエスト/ジョブのみ渡す。
- BFF は Cognito で認証し、アプリ用セッションを HttpOnly Cookie で管理する。

## 認証（Cognito + 独自UI + BFF）
- IdP: Cognito User Pool を採用する。
- フロー: BFF ログインで Cognito を呼び出す（`USER_PASSWORD_AUTH` を推奨、必要に応じて `ADMIN_USER_PASSWORD_AUTH` を使用）。
- サインアップ: 管理者招待を基本とし、自己登録は当面無効化する。
- MFA: 任意から開始し、将来的に必須化可能な設定を前提とする。
- 主要トークン: Cognito `idToken` を検証し、BFF がアプリ用セッションを発行する。

## Cognito 推奨設定（初期）
- サインイン属性: email（ユーザー名は email として扱う）。
- App Client: secret なし（シンプル運用）、`USER_PASSWORD_AUTH` と `REFRESH_TOKEN_AUTH` を許可。
- トークン有効期限: access/id 15分、refresh 30日。
- パスワードポリシー: 8文字以上・大文字/小文字/数字を必須。
- `ADMIN_USER_PASSWORD_AUTH` を使う場合は BFF に IAM 権限が必要（最小権限で付与）。
- Terraform 定義: `infra/terraform/cognito/main.tf`

## CSRF 対策（BFF + HttpOnly Cookie）
- SameSite=Lax の Cookie を前提にし、状態変更系（POST/PUT/PATCH/DELETE）は Origin/Referer を検証する。
- GET で状態変更しない（CSRFで悪用されるため）。
- 同一ドメイン運用のため、CSRF トークンは当面不要とする。
- 例外（別ドメイン運用や iframe 埋め込みなど）が発生した場合は CSRF トークンを追加する。

## セッション/トークン運用
- セッションは HttpOnly Cookie に保存し、JavaScript からは読み取れないようにする。
- BFF は Cognito `idToken` の署名検証後、`tenantId`/`role` を埋め込んだアプリ用 JWT を発行する。
- リフレッシュは Cognito `refresh token` を使用し、BFF が `/api/auth/refresh` で更新する。
- ログアウトは Cookie を削除し、必要に応じて Cognito の `globalSignOut` を呼ぶ。
- App Client に secret を設定する場合、`/api/auth/refresh` は `refreshToken` に加えて `email` を受け取る。
- secret なしの場合は `refreshToken` のみで更新できる。

## ユーザー/テナント紐付け
- `userId` は Cognito の `sub` を採用する。
- DynamoDB の `USER` アイテムに `tenantId` と `role` を保持し、GSI で `userId -> tenantId` を逆引きできるようにする。
- Cognito Group は使わず、権限のソースは DynamoDB を正とする。
- 詳細なキー設計は `docs/architecture/データベース設計.md` を参照。

## RBAC
- 役割: Admin / Manager / Member（最小）。write系エージェントは Admin/Manager のみ実行可、承認ゲートでの承認者も役割で制御。
- ポリシー: ルート/ハンドラごとに required roles を定義し、ミドルウェアで強制。
- エンタイトルメント: tenant × agent で利用可否・回数上限を持ち、ミドルウェアでチェックしたうえで実行許可。

## テナント分離
- DB: DynamoDB のシングルテーブル設計を採用し、PK に `tenantId` を含める。
- テナント外アクセスは BFF 側の検証に加え、DynamoDB の `ConditionExpression` で二重防御する。
- ストレージ/キャッシュ/キュー: キー/プレフィックス/トピック名に `tenantId` を含め、ACLで分離。
- ベクトルストア: インデックス/ネームスペースをテナント単位で分ける。

## BFF ミドルウェア（Next.js Route Handler）
- 認証検証 → テナント解決 → エンタイトルメント/RBACチェック → ログ用トレースID付与 → ハンドラ実行。
- 失敗時は分類したエラー（認証不足/権限不足/テナント不一致/レート上限超過など）を返却。

## AgentCore 側の二重チェック
- 受信したジョブ/APIについて `tenantId` の存在と許可された agent/スコープかを再検証。
- 同期APIにはタイムアウトと rate limit を設定し、非同期キューは冪等性キーを必須。

## 監査とログ
- 誰が/どのテナントで/どのエージェントを/どの入力で/どの結果になったかを記録。PIIはマスキングまたはハッシュ。
- 承認ゲートの承認者・時刻・差分を記録。

## レート/クォータ
- tenant × agent で回数上限、プラン(Basic/Pro)で月次Quotaを設定。実行前に残量をチェックし、枯渇時はガイドメッセージを返す。

## データ運用
- DynamoDB はスキーマレスのため、属性追加は段階的に行い、互換性のある読み取りを保つ。
- ローカル/CI は DynamoDB Local とシードスクリプトで再現する。
