# ローカルツールセットアップ（Python / Terraform / Playwright）

develop の pre-push で必要になるツールを「コピペで完結」できる形でまとめます。特に指定がない限り、リポジトリのルート（`/develop/project/ai-agent`）で実行してください。

## 共通前提

- Node/pnpm は既にインストール済みであること（pnpm 10系想定）。
- シェルは bash/zsh を想定。

## Python / ruff / pytest

Python 3.11 と ruff / pytest を用意します。PEP 668 で `--user` が弾かれる環境があるため、pipx でのインストールを推奨します（フックから直接呼べるよう PATH も通します）。

macOS (Homebrew):

```bash
brew install python@3.11 pipx
pipx ensurepath              # ~/.local/bin を PATH へ追加（指示に従ってシェル再読込）
pipx install ruff
pipx install pytest
```

Ubuntu/Debian:

```bash
sudo apt-get update && sudo apt-get install -y python3 python3-venv pipx
pipx ensurepath              # ~/.local/bin を PATH へ追加（指示に従ってシェル再読込）
pipx install ruff
pipx install pytest
```

確認:

```bash
python3 --version   # 3.11 以上を確認
ruff --version
pytest --version
```

補足: pipx が使えない場合は、リポジトリ直下で `python3 -m venv .venv && ./.venv/bin/pip install ruff pytest` を実行し、`export PATH="/develop/project/ai-agent/.venv/bin:$PATH"` をシェルの rc に追加してください。

## Terraform

macOS (Homebrew):

```bash
brew tap hashicorp/tap
brew install hashicorp/tap/terraform
terraform version
```

Ubuntu/Debian:

```bash
T_VERSION=1.8.0
wget https://releases.hashicorp.com/terraform/${T_VERSION}/terraform_${T_VERSION}_linux_amd64.zip
unzip terraform_${T_VERSION}_linux_amd64.zip
sudo mv terraform /usr/local/bin/
rm terraform_${T_VERSION}_linux_amd64.zip
terraform version
```

## Playwright ブラウザ

リポジトリのルートで実行:

```bash
pnpm install                    # まだの場合
pnpm --filter @ai-agent/web exec playwright install --with-deps
pnpm --filter @ai-agent/web exec playwright --version
```

## Web 依存不足（clsx）の補足

- 症状: `tsc --noEmit` で `Cannot find module 'clsx'`（`components/ui/Button.tsx` など）と出る。
- 対応: リポジトリルートで `pnpm add clsx --filter @ai-agent/web` を実行。
- 確認: `pnpm --filter @ai-agent/web type-check` が通ることを確認。

## まとめ

上記コマンドが通れば、pre-push の全チェック（webのユニット/統合/ビルド、Python lint/test、Terraform fmt/validate、E2E）がローカルで実行できる状態になります。\*\*\*

## Docker Compose (Ubuntu/WSL)

- v2 プラグイン（推奨、`docker compose ...` が使える）

  ```bash
  sudo apt-get update
  sudo apt-get install -y ca-certificates curl gnupg
  sudo install -m 0755 -d /etc/apt/keyrings
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  sudo chmod a+r /etc/apt/keyrings/docker.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu noble stable" | sudo tee /etc/apt/sources.list.d/docker.list
  sudo apt-get update
  sudo apt-get install -y docker-compose-plugin
  docker compose version
  ```

- v1（`docker-compose ...` を使う従来版、簡易だが非推奨）
  ```bash
  sudo apt-get update
  sudo apt-get install -y docker-compose
  docker-compose version
  ```

## DynamoDB Local（開発/テスト用）

- 起動:
  ```bash
  docker compose -f docker-compose.dynamodb.yml up -d
  ```
- シード（テーブル作成と初期データ投入）:
  ```bash
  DYNAMODB_ENDPOINT=http://localhost:8000 pnpm exec node packages/db-dynamo/scripts/seed.mjs
  ```
- ログイン検証用の管理者ユーザーを作る場合:
  - 先に Cognito で管理者ユーザーを作成し、`sub` を確認する
  - `SEED_ADMIN_SUB` に `sub` を渡してシードを実行する
  ```bash
  SEED_ADMIN_SUB=<cognito-sub> \
  SEED_ADMIN_EMAIL=admin@example.com \
  DYNAMODB_ENDPOINT=http://localhost:8000 \
  pnpm exec node packages/db-dynamo/scripts/seed.mjs
  ```
- テスト実行例（明示的にローカルを指定したい場合）:

  ```bash
  DYNAMODB_ENDPOINT=http://localhost:8000 \
  AWS_REGION=ap-northeast-1 \
  AWS_ACCESS_KEY_ID=local \
  AWS_SECRET_ACCESS_KEY=local \
  pnpm --filter @ai-agent/web test:integration
  ```

- GUI で中身を確認したい場合（簡易UI）
  ```bash
  npx dynamodb-admin   # デフォルト http://localhost:8001
  ```
  ※DynamoDB Local を http://localhost:8000 で起動している前提。ポートを変える場合は `PORT=9001 npx dynamodb-admin` などで指定可能。

## 初期テナント/管理者の作成（ローカル向け）

このプロジェクトは **自己登録を無効化** しているため、**初期管理者は自分で作る必要**があります。
最初の Admin が作成されると、以後は Admin 権限で `/api/tenants` や `/api/users` から追加作成できます。

### 手順（最初の 1 回だけ）

1. **Cognito に管理者ユーザーを作成**（コンソール or CLI で OK）
2. Cognito の **`sub` を確認**
3. DynamoDB Local に **テナント + 管理者ユーザー** を登録（シードスクリプト）

※ dev/staging/prod など **クラウド環境の初期化は `docs/01-CI-CD-クイックスタート.md` を参照**してください。

## DynamoDB のテーブル構成（マルチテーブル）

- アプリ用のテーブルは用途別に分割（例: `aiagent-dev-users`, `aiagent-dev-tenants` など）
- `aiagent-terraform-lock` は **Terraform state ロック用**で、アプリデータとは無関係
- ベース名（例: `aiagent-dev`）は **テーブル名プレフィックス**として扱う

詳細は `docs/architecture/データベース設計.md` を参照。

## リソース名の一括変更（プロジェクト名プレフィックス）

Terraform の `TF_PROJECT` を変えると、**Cognito/DynamoDB/IAM/KMS** などのリソース名を一括変更できます。
※このドキュメントでは Terraform を実行しないので、**実行は `docs/01-CI-CD-クイックスタート.md` 側**で行ってください。

例:

```bash
TF_PROJECT=aiagent \
TF_STATE_BUCKET=aiagent-terraform-state \
TF_STATE_LOCK_TABLE=aiagent-terraform-lock \
AWS_REGION=ap-northeast-1 \
./scripts/terraform/provision-all.sh dev apply
```

アプリが参照するテーブル名は `DYNAMODB_TABLE_NAME`（例: `aiagent-dev`）に合わせてください。
