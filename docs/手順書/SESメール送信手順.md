# SESでメール送信を行う手順（Route53ドメインを同一AWSアカウントで管理している場合）

目的: Amazon SES を使ってメール送信できる状態にする（申請者/管理者への通知など）。

参考:https://carbonated-hope-47f.notion.site/SES-21ee2a0a5efe80cda74af3fe26f9dfda?pvs=74

---

## 前提

- Route53 に **対象ドメインの Hosted Zone が存在**し、同一AWSアカウント内で管理できること
  - この場合、SESの「ID（ドメイン）」を作成すれば、DNSレコード登録まで同一アカウント内で完結しやすい

---

## 手順（ドメインID作成 → 検証 → DKIM → DMARC）

### 1) SESコンソールから「ID」を作成する

1. Amazon SESコンソールで **「ID」** を選択
2. **「IDの作成」** を押下

### 2) 「IDタイプ」で「ドメイン」を選択して作成する

1. IDタイプで **「ドメイン」** を選択
2. 認証させたいドメイン名を入力
3. DKIM（推奨）など必要な設定を入力して作成

### 3) ドメイン認証の成功可否を確認する

- ドメイン作成後、SESが **ドメイン認証** を実施します
- DNS反映に数分かかることがあるため、ブラウザ更新などで成功可否を確認します

### 4) DKIMの成功可否を確認する（推奨）

- 送信元改ざん防止の信頼性向上のため、DKIMも同様に成功可否を確認します

#### 失敗した場合

- Route53のDNSゾーンに登録された **CNAMEレコード** の設定値（キー/値）を確認します


### 5) DMARCを設定する（推奨）

- 送信元のなりすまし防止と信頼性向上のため、DMARCを設定します

---

## 注意: 上記だけでは「検証済みのメールアドレス」にしか送れない場合がある

SESが **サンドボックス** 状態の場合、基本的に以下の制約があります。

- 送信先が **検証済みアドレス** に限定される（未検証の宛先へ送れない）

---

## 未検証のメールアドレスにも送信したい（本番アクセス申請）

SESコンソールから **本番リクエスト（Production access）** を行います。

- 「設定をはじめる」 → 「本番リクエスト」
- 数分で検証済み（本番相当）になることがある

※ 審査が入る場合があるため、状況によって所要時間は変動します。

---

## メール送信テスト（サンドボックス中でも動作確認したい場合）

### 1) 送信先メールアドレスを登録する

サンドボックス中は登録しているメールアドレスにしか送れないため、まず宛先を検証します。

1. SESコンソール → **ID** → **IDの作成**
2. **Emailアドレス** を選択
3. 個人のGmailなどを登録（届くメールのリンク等で検証）

### 2) テストメールを送信する

- テスト送信の画面で、シナリオは **カスタム** を選ぶと、登録済みのメールアドレスに送信可能

---

## 付録（このリポジトリのアプリ設定例）

アプリ側は環境変数で切り替えます（例: `config/env.example`）。

- `EMAIL_PROVIDER`: `ses | console | disabled`
- `EMAIL_FROM`: 送信元（SESで検証済みのFromを推奨）
- `TENANT_APPLICATION_ADMIN_EMAILS`: 管理者通知先（カンマ区切り）
