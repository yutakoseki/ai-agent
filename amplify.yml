version: 1
applications:
  - appRoot: apps/web
    frontend:
      phases:
        preBuild:
          commands:
            - corepack enable
            - pnpm install
            - echo "COGNITO_REGION=$COGNITO_REGION" >> .env
            - echo "COGNITO_USER_POOL_ID=$COGNITO_USER_POOL_ID" >> .env
            - echo "COGNITO_CLIENT_ID=$COGNITO_CLIENT_ID" >> .env
            - echo "COGNITO_AUTH_FLOW=$COGNITO_AUTH_FLOW" >> .env
            - echo "AMPLIFY_AWS_REGION=$AMPLIFY_AWS_REGION" >> .env
            - echo "AMPLIFY_AWS_ACCESS_KEY_ID=$AMPLIFY_AWS_ACCESS_KEY_ID" >> .env
            - echo "AMPLIFY_AWS_SECRET_ACCESS_KEY=$AMPLIFY_AWS_SECRET_ACCESS_KEY" >> .env
        build:
          commands:
            - pnpm build
            - node ./scripts/patch-next-trace.mjs .next
      artifacts:
        # Amplify の Web Compute バンドラは `.next/server` を基点に bundle を作るため、成果物ルートは `.next` に揃える
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
    amplifyHosting:
      config:
        SSR: true
