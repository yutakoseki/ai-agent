version: 1
applications:
  - appRoot: apps/web
    frontend:
      phases:
        preBuild:
          commands:
            - corepack enable
            - pnpm install
        build:
          commands:
            - pnpm build
            - mkdir -p .next/standalone/apps/web/.next/static
            - cp -R .next/static/. .next/standalone/apps/web/.next/static
            - if [ -d public ]; then mkdir -p .next/standalone/apps/web/public && cp -R public/. .next/standalone/apps/web/public; fi
            - mkdir -p .next/node_modules
            - rm -rf .next/node_modules/next
            - NEXT_PNPM_DIR=$(ls -d .next/standalone/node_modules/.pnpm/next@* 2>/dev/null | head -n 1)
            - if [ -z "$NEXT_PNPM_DIR" ]; then NEXT_PNPM_DIR=$(ls -d ../../node_modules/.pnpm/next@* 2>/dev/null | head -n 1); fi
            - if [ -n "$NEXT_PNPM_DIR" ]; then mkdir -p .next/node_modules/next && cp -R "$NEXT_PNPM_DIR/node_modules/next/." .next/node_modules/next; fi
      artifacts:
        baseDirectory: .next
        files:
          - "**/*"
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
